<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inbox ‚Äî Audio City</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: #111;
      color: #fff;
      height: 100vh;
      overflow: hidden;
    }

    /* Header */
    header {
      background: #000;
      padding: 12px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #222;
      height: 60px;
    }
    
    .logo {
      font-size: 24px;
      font-weight: 900;
      color: #fff;
      text-decoration: none;
    }
    
    nav {
      display: flex;
      gap: 8px;
    }
    
    nav a {
      padding: 8px 16px;
      color: #888;
      text-decoration: none;
      border-radius: 8px;
      font-size: 14px;
    }
    
    nav a:hover, nav a.active {
      color: #fff;
      background: rgba(255,255,255,0.1);
    }

    /* Main Container */
    .container {
      display: flex;
      height: calc(100vh - 60px);
    }

    /* Left Sidebar - Conversations List */
    .sidebar {
      width: 350px;
      background: #111;
      border-right: 1px solid #222;
      display: flex;
      flex-direction: column;
    }

    .sidebar-header {
      padding: 16px;
      border-bottom: 1px solid #222;
      font-size: 20px;
      font-weight: 600;
    }

    .conversations {
      flex: 1;
      overflow-y: auto;
    }

    .conversation-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid #1a1a1a;
      transition: background 0.2s;
    }

    .conversation-item:hover {
      background: #1a1a1a;
    }

    .conversation-item.active {
      background: #1f1f1f;
    }

    .conversation-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: #333;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
      overflow: hidden;
    }

    .conversation-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .conversation-info {
      flex: 1;
      min-width: 0;
    }

    .conversation-name {
      font-weight: 500;
      font-size: 16px;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .conversation-preview {
      color: #888;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .conversation-time {
      color: #666;
      font-size: 12px;
      flex-shrink: 0;
    }

    .unread-badge {
      background: #25d366;
      color: #fff;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 10px;
      margin-left: 8px;
    }

    /* Right Side - Chat Area */
    .chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #0a0a0a;
    }

    /* Chat Header */
    .chat-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: #111;
      border-bottom: 1px solid #222;
      height: 65px;
    }

    .chat-header-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #333;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .chat-header-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .chat-header-info h3 {
      font-size: 16px;
      font-weight: 500;
    }

    .chat-header-info p {
      font-size: 13px;
      color: #888;
    }

    /* Messages Area */
    .messages-area {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .message {
      max-width: 70%;
      padding: 10px 14px;
      border-radius: 18px;
      font-size: 15px;
      line-height: 1.4;
      word-wrap: break-word;
    }

    .message.sent {
      align-self: flex-end;
      background: #25d366;
      color: #fff;
      border-bottom-right-radius: 4px;
    }

    .message.received {
      align-self: flex-start;
      background: #262626;
      color: #fff;
      border-bottom-left-radius: 4px;
    }

    .message-time {
      font-size: 11px;
      opacity: 0.7;
      margin-top: 4px;
      text-align: right;
    }

    /* Input Area */
    .input-area {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: #111;
      border-top: 1px solid #222;
    }

    .input-area input {
      flex: 1;
      background: #262626;
      border: none;
      padding: 12px 16px;
      border-radius: 24px;
      color: #fff;
      font-size: 15px;
    }

    .input-area input:focus {
      outline: none;
    }

    .input-area input::placeholder {
      color: #666;
    }

    .send-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: #25d366;
      border: none;
      color: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      transition: background 0.2s;
    }

    .send-btn:hover {
      background: #1da851;
    }

    .send-btn:disabled {
      background: #333;
      cursor: not-allowed;
    }

    /* Empty States */
    .empty-state {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #666;
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }

    .empty-state-text {
      font-size: 18px;
      margin-bottom: 8px;
    }

    .empty-state-sub {
      font-size: 14px;
      color: #555;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .sidebar {
        width: 100%;
        display: block;
      }
      
      .chat-area {
        display: none;
        position: fixed;
        top: 60px;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 100;
      }
      
      .chat-area.active {
        display: flex;
      }
      
      .back-btn {
        display: block;
      }
    }

    .back-btn {
      display: none;
      background: none;
      border: none;
      color: #fff;
      font-size: 24px;
      cursor: pointer;
      padding: 8px;
      margin-right: 8px;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: #333;
      border-radius: 3px;
    }
  </style>
</head>
<body>
  <header>
    <a href="index.html" class="logo">AUDIO CITY</a>
    <nav>
      <a href="discover.html">Home</a>
      <a href="feed.html">Feed</a>
      <a href="artists.html">Artists</a>
      <a href="inbox.html" class="active">Inbox</a>
    </nav>
  </header>

  <div class="container">
    <!-- Left: Conversations List -->
    <div class="sidebar">
      <div class="sidebar-header">Messages</div>
      <div class="conversations" id="conversationsList">
        <div class="empty-state">
          <div class="empty-state-icon">üí¨</div>
          <div class="empty-state-text">No conversations yet</div>
          <div class="empty-state-sub">Start chatting with artists!</div>
        </div>
      </div>
    </div>

    <!-- Right: Chat Area -->
    <div class="chat-area" id="chatArea">
      <div class="empty-state" id="noChatSelected">
        <div class="empty-state-icon">üí¨</div>
        <div class="empty-state-text">Select a conversation</div>
        <div class="empty-state-sub">Choose from your messages on the left</div>
      </div>
      
      <!-- Active Chat (hidden by default) -->
      <div id="activeChat" style="display: none; flex-direction: column; height: 100%;">
        <div class="chat-header">
          <button class="back-btn" onclick="closeChat()">‚Üê</button>
          <div class="chat-header-avatar" id="chatAvatar">üë§</div>
          <div class="chat-header-info">
            <h3 id="chatName">User</h3>
            <p id="chatStatus">Online</p>
          </div>
        </div>
        
        <div class="messages-area" id="messagesArea">
          <!-- Messages will be inserted here -->
        </div>
        
        <div class="input-area">
          <input type="text" id="messageInput" placeholder="Type a message..." onkeypress="handleKeyPress(event)">
          <button class="send-btn" id="sendBtn" onclick="sendMessage()">‚û§</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE_URL = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
      ? 'http://localhost:3002'
      : 'https://api.audiocity-ug.com';

    let currentUserId = localStorage.getItem('user_id');
    let currentChatUserId = null;
    let currentConversationId = null;

    // Generate conversation ID (sorted for consistency)
    function getConversationId(userId1, userId2) {
      return [userId1, userId2].sort().join('_');
    }

    // Format time
    function formatTime(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      const now = new Date();
      const diff = now - date;
      
      if (diff < 60000) return 'Just now';
      if (diff < 3600000) return Math.floor(diff / 60000) + 'm';
      if (diff < 86400000) return Math.floor(diff / 3600000) + 'h';
      return Math.floor(diff / 86400000) + 'd';
    }

    // Format message time
    function formatMessageTime(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    // Load conversations
    async function loadConversations() {
      if (!currentUserId) {
        document.getElementById('conversationsList').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üîí</div>
            <div class="empty-state-text">Please log in</div>
            <div class="empty-state-sub"><a href="login.html" style="color: #25d366;">Sign in</a> to view messages</div>
          </div>
        `;
        return;
      }

      try {
        const res = await fetch(`${API_BASE_URL}/api/users/${currentUserId}/messages`, {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('auth_token')}` }
        });
        
        if (res.ok) {
          const data = await res.json();
          renderConversations(data);
        } else {
          renderConversations([]);
        }
      } catch (e) {
        console.error('Error loading conversations:', e);
        renderConversations([]);
      }
    }

    // Render conversations list
    async function renderConversations(conversations) {
      const container = document.getElementById('conversationsList');
      
      if (!conversations || conversations.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üí¨</div>
            <div class="empty-state-text">No conversations yet</div>
            <div class="empty-state-sub">Start chatting with artists!</div>
          </div>
        `;
        return;
      }

      // Group by other user
      const grouped = new Map();
      for (const conv of conversations) {
        const otherUserId = conv.id || conv.conversation_id || conv.sender_id;
        if (!otherUserId || otherUserId === currentUserId) continue;
        
        if (!grouped.has(otherUserId)) {
          grouped.set(otherUserId, {
            oderId: otherUserId,
            lastMessage: conv.last_message || conv.text || conv.content || '',
            lastTime: conv.created_at || conv.updated_at || '',
            unread: conv.read === 0 || conv.read === false,
            name: conv.sender_name || conv.name || null,
            avatar: conv.sender_avatar || conv.avatar || conv.profile_image_url || null
          });
        }
      }

      // Fetch user info for each conversation
      const items = [];
      for (const [userId, conv] of grouped) {
        if (!conv.name) {
          try {
            const userRes = await fetch(`${API_BASE_URL}/api/users/${userId}`);
            if (userRes.ok) {
              const userData = await userRes.json();
              conv.name = userData.name || userData.username || 'User';
              conv.avatar = userData.profile_image_url || userData.avatar_url || null;
            }
          } catch (e) {
            conv.name = 'User';
          }
        }
        items.push({ oderId: userId, ...conv });
      }

      // Sort by last message time
      items.sort((a, b) => new Date(b.lastTime || 0) - new Date(a.lastTime || 0));

      container.innerHTML = items.map(conv => `
        <div class="conversation-item" onclick="openChat('${conv.oderId}')">
          <div class="conversation-avatar">
            ${conv.avatar ? `<img src="${conv.avatar}" alt="">` : 'üë§'}
          </div>
          <div class="conversation-info">
            <div class="conversation-name">${escapeHtml(conv.name || 'User')}</div>
            <div class="conversation-preview">${escapeHtml(conv.lastMessage || 'No messages')}</div>
          </div>
          <div style="text-align: right;">
            <div class="conversation-time">${formatTime(conv.lastTime)}</div>
            ${conv.unread ? '<span class="unread-badge">1</span>' : ''}
          </div>
        </div>
      `).join('');
    }

    // Open chat with user
    async function openChat(userId) {
      currentChatUserId = userId;
      currentConversationId = getConversationId(currentUserId, userId);

      // Show chat UI
      document.getElementById('noChatSelected').style.display = 'none';
      document.getElementById('activeChat').style.display = 'flex';
      document.getElementById('chatArea').classList.add('active');

      // Mark conversation as active
      document.querySelectorAll('.conversation-item').forEach(el => el.classList.remove('active'));
      event.target.closest('.conversation-item')?.classList.add('active');

      // Load user info
      try {
        const res = await fetch(`${API_BASE_URL}/api/users/${userId}`);
        if (res.ok) {
          const user = await res.json();
          document.getElementById('chatName').textContent = user.name || user.username || 'User';
          const avatar = document.getElementById('chatAvatar');
          if (user.profile_image_url || user.avatar_url) {
            avatar.innerHTML = `<img src="${user.profile_image_url || user.avatar_url}" alt="">`;
          } else {
            avatar.innerHTML = 'üë§';
          }
        }
      } catch (e) {
        console.error('Error loading user:', e);
      }

      // Load messages
      await loadMessages();

      // Mark as read
      try {
        await fetch(`${API_BASE_URL}/api/conversations/${currentUserId}/${userId}/messages/read`, {
          method: 'PUT',
          headers: { 'Authorization': `Bearer ${localStorage.getItem('auth_token')}` }
        });
      } catch (e) {}
    }

    // Close chat (mobile)
    function closeChat() {
      document.getElementById('noChatSelected').style.display = 'flex';
      document.getElementById('activeChat').style.display = 'none';
      document.getElementById('chatArea').classList.remove('active');
      currentChatUserId = null;
    }

    // Load messages for current chat
    async function loadMessages() {
      if (!currentChatUserId) return;

      const container = document.getElementById('messagesArea');
      
      try {
        const res = await fetch(`${API_BASE_URL}/api/conversations/${currentUserId}/${currentChatUserId}/messages`, {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('auth_token')}` }
        });

        if (res.ok) {
          const messages = await res.json();
          renderMessages(messages);
        } else {
          container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üí¨</div><div class="empty-state-text">Start the conversation!</div></div>';
        }
      } catch (e) {
        console.error('Error loading messages:', e);
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><div class="empty-state-text">Error loading messages</div></div>';
      }
    }

    // Render messages
    function renderMessages(messages) {
      const container = document.getElementById('messagesArea');

      if (!messages || messages.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üí¨</div><div class="empty-state-text">Start the conversation!</div></div>';
        return;
      }

      // Sort by time
      const sorted = [...messages].sort((a, b) => 
        new Date(a.created_at || 0) - new Date(b.created_at || 0)
      );

      container.innerHTML = sorted.map(msg => {
        const isSent = (msg.sender_id || msg.senderId) === currentUserId;
        const content = msg.content || msg.text || msg.message || '';
        const time = formatMessageTime(msg.created_at);

        return `
          <div class="message ${isSent ? 'sent' : 'received'}">
            <div>${escapeHtml(content)}</div>
            <div class="message-time">${time}</div>
          </div>
        `;
      }).join('');

      // Scroll to bottom
      container.scrollTop = container.scrollHeight;
    }

    // Send message
    async function sendMessage() {
      const input = document.getElementById('messageInput');
      const text = input.value.trim();
      
      if (!text || !currentChatUserId) return;

      const sendBtn = document.getElementById('sendBtn');
      sendBtn.disabled = true;

      try {
        const res = await fetch(`${API_BASE_URL}/api/conversations/${currentUserId}/${currentChatUserId}/messages`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
          },
          body: JSON.stringify({
            sender_id: currentUserId,
            recipient_id: currentChatUserId,
            content: text
          })
        });

        if (res.ok) {
          input.value = '';
          await loadMessages();
          loadConversations(); // Update sidebar
        } else {
          const err = await res.json().catch(() => ({}));
          alert('Failed to send: ' + (err.error || 'Unknown error'));
        }
      } catch (e) {
        console.error('Error sending:', e);
        alert('Error sending message');
      } finally {
        sendBtn.disabled = false;
      }
    }

    // Handle Enter key
    function handleKeyPress(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    }

    // Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }

    // Check URL params
    function checkUrlParams() {
      const params = new URLSearchParams(window.location.search);
      const userId = params.get('user');
      if (userId) {
        openChat(userId);
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadConversations();
      checkUrlParams();
    });
  </script>
</body>
</html>
